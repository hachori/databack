# app.py
import streamlit as st
import pandas as pd
import plotly.express as px

# ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
@st.cache_data
def load_data():
    return pd.read_csv("BestLoanList_20250527071549.csv", encoding="cp949")

df = load_data()

st.title("ğŸ“š ë„ì„œ ëŒ€ì¶œ í˜„í™© ëŒ€ì‹œë³´ë“œ")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ğŸ“Œ ë„ì„œëª… ê²€ìƒ‰ ê¸°ëŠ¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("ğŸ” ë„ì„œëª…ìœ¼ë¡œ ëŒ€ì¶œ ìˆœìœ„ í™•ì¸")

book_name = st.text_input("ë„ì„œëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: í”í•œë‚¨ë§¤)").strip()

if book_name:
    matched_books = df[df["ì„œëª…"].str.contains(book_name, case=False, na=False)]

    if not matched_books.empty:
        st.success(f"ğŸ” ì´ {len(matched_books)}ê¶Œì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.")
        st.dataframe(matched_books[["ìˆœìœ„", "ì„œëª…", "ì €ì", "ì¶œíŒì‚¬", "ì¶œíŒë…„ë„", "ëŒ€ì¶œê±´ìˆ˜"]].sort_values(by="ìˆœìœ„"))
    else:
        st.warning("â— í•´ë‹¹ ë„ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì •í™•í•œ ë„ì„œëª…ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1. ìƒìœ„ ëŒ€ì¶œ ë„ì„œ ì‹œê°í™”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("ğŸ“ˆ ìƒìœ„ ëŒ€ì¶œ ë„ì„œ")

top_n = st.slider("ìƒìœ„ ëª‡ ê¶Œì˜ ë„ì„œë¥¼ ë³¼ê¹Œìš”?", 5, 50, 20)
top_books = df.sort_values(by="ëŒ€ì¶œê±´ìˆ˜", ascending=False).head(top_n)

fig1 = px.bar(top_books, x="ì„œëª…", y="ëŒ€ì¶œê±´ìˆ˜",
              hover_data=["ì €ì", "ì¶œíŒì‚¬", "ì¶œíŒë…„ë„"],
              title=f"Top {top_n} ëŒ€ì¶œ ë„ì„œ",
              labels={"ì„œëª…": "ì±… ì œëª©", "ëŒ€ì¶œê±´ìˆ˜": "ëŒ€ì¶œ ê±´ìˆ˜"})
fig1.update_layout(xaxis_tickangle=-45)
st.plotly_chart(fig1, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. ì¶œíŒë…„ë„ë³„ ëŒ€ì¶œ ê±´ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("ğŸ“… ì¶œíŒë…„ë„ë³„ ëŒ€ì¶œ ê±´ìˆ˜")
yearly = df.groupby("ì¶œíŒë…„ë„")["ëŒ€ì¶œê±´ìˆ˜"].sum().reset_index().sort_values("ì¶œíŒë…„ë„")

fig2 = px.line(yearly, x="ì¶œíŒë…„ë„", y="ëŒ€ì¶œê±´ìˆ˜",
               title="ì¶œíŒë…„ë„ë³„ ì´ ëŒ€ì¶œ ê±´ìˆ˜ ì¶”ì´")
st.plotly_chart(fig2, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3. ì¶œíŒì‚¬ë³„ ëŒ€ì¶œ í˜„í™©
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("ğŸ¢ ì¶œíŒì‚¬ë³„ ëŒ€ì¶œ ê±´ìˆ˜ (ìƒìœ„ 10ê°œ)")
publisher = df.groupby("ì¶œíŒì‚¬")["ëŒ€ì¶œê±´ìˆ˜"].sum().reset_index()
top_publishers = publisher.sort_values(by="ëŒ€ì¶œê±´ìˆ˜", ascending=False).head(10)

fig3 = px.bar(top_publishers, x="ì¶œíŒì‚¬", y="ëŒ€ì¶œê±´ìˆ˜",
              title="ëŒ€ì¶œ ê±´ìˆ˜ ìƒìœ„ ì¶œíŒì‚¬", text="ëŒ€ì¶œê±´ìˆ˜")
st.plotly_chart(fig3, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4. ì €ìë³„ ëŒ€ì¶œ ê±´ìˆ˜ (ìƒìœ„ 10ëª…)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("âœï¸ ì €ìë³„ ëŒ€ì¶œ ê±´ìˆ˜ (ìƒìœ„ 10ëª…)")
author = df.groupby("ì €ì")["ëŒ€ì¶œê±´ìˆ˜"].sum().reset_index()
top_authors = author.sort_values(by="ëŒ€ì¶œê±´ìˆ˜", ascending=False).head(10)

fig4 = px.bar(top_authors, x="ì €ì", y="ëŒ€ì¶œê±´ìˆ˜",
              title="ëŒ€ì¶œ ê±´ìˆ˜ ìƒìœ„ ì €ì", text="ëŒ€ì¶œê±´ìˆ˜")
st.plotly_chart(fig4, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5. KDC ë¶„ë¥˜ë³„ ëŒ€ì¶œ ê±´ìˆ˜
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.header("ğŸ“š KDC ë¶„ë¥˜ë³„ ëŒ€ì¶œ ê±´ìˆ˜")
df["KDC"] = df["KDC"].astype(str).str[:1]  # ëŒ€ë¶„ë¥˜ë§Œ ì‚¬ìš© (0~9)
kdc = df.groupby("KDC")["ëŒ€ì¶œê±´ìˆ˜"].sum().reset_index()

fig5 = px.pie(kdc, names="KDC", values="ëŒ€ì¶œê±´ìˆ˜", title="KDC ëŒ€ë¶„ë¥˜ë³„ ëŒ€ì¶œ ë¹„ìœ¨")
st.plotly_chart(fig5, use_container_width=True)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6. ì›ë³¸ ë°ì´í„° í™•ì¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.checkbox("ğŸ” ì›ë³¸ ë°ì´í„° ë³´ê¸°"):
    st.dataframe(df)
